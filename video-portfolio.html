<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WXZ STUDIO - 视频作品</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="nav-content container">
            <div class="logo"><a href="index.html">WXZ STUDIO</a></div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="video-portfolio.html" class="active">视频作品</a></li>
                    <li><a href="graphic-portfolio.html">平面设计作品</a></li>
                    <li><a href="contact.html">联系方式</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <section class="portfolio-section">
            <div class="container">
                <h2>视频作品集</h2>
                <div class="tags-filter">
                    <span class="work-tag active" data-filter="all">全部</span>
                    <span class="work-tag" data-filter="event">商业活动</span>
                    <span class="work-tag" data-filter="product">产品拍摄</span>
                    <span class="work-tag" data-filter="brand">品牌宣传</span>
                </div>
                
                <div class="portfolio-grid video-portfolio-grid">
                    
                    <div class="work-item" data-tags="brand product" data-video-src="assets/videos/portfolio/video-01.mp4">
                        <div class="work-media">
                            <video muted loop preload="metadata">
                                <source src="assets/videos/portfolio/video-01.mp4" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                        <div class="work-info">
                            <h3>2024年度混剪</h3>
                            <div class="work-tags"><span class="work-tag">品牌宣传</span></div>
                        </div>
                    </div>

                    <div class="work-item" data-tags="brand event" data-video-src="assets/videos/portfolio/video-02.mp4">
                        <div class="work-media">
                            <video muted loop preload="metadata">
                                <source src="assets/videos/portfolio/video-02.mp4" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                        <div class="work-info">
                            <h3>首尔时装周</h3>
                            <div class="work-tags"><span class="work-tag">商业活动</span></div>
                        </div>
                    </div>

                    <div class="work-item" data-tags="event" data-video-src="assets/videos/portfolio/video-03.mp4">
                        <div class="work-media">
                            <video muted loop preload="metadata">
                                <source src="assets/videos/portfolio/video-03.mp4" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                        <div class="work-info">
                            <h3>高端晚宴</h3>
                            <div class="work-tags"><span class="work-tag">商业活动</span></div>
                        </div>
                    </div>

                    <div class="work-item" data-tags="brand product" data-video-src="assets/videos/portfolio/video-04.mp4">
                        <div class="work-media">
                            <video muted loop preload="metadata">
                                <source src="assets/videos/portfolio/video-04.mp4" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                        <div class="work-info">
                            <h3>新世界免税店 x 首尔月</h3>
                            <div class="work-tags"><span class="work-tag">产品拍摄</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 WXZ STUDIO. All Rights Reserved. </p>
        </div>
    </footer>

    <div id="videoModal" class="video-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="videoPlayerContainer"></div>
        </div>
    </div>
    
    <nav class="mobile-nav">
        <div class="mobile-menu-icons">
            <a href="index.html">
                <img src="assets/images/icons/home.png" class="icon-default" alt="首页">
                <img src="assets/images/icons/home-active.png" class="icon-active" alt="首页 Active">
                <span>首页</span>
            </a>
            <a href="video-portfolio.html" class="active">
                <img src="assets/images/icons/video.png" class="icon-default" alt="视频作品">
                <img src="assets/images/icons/video-active.png" class="icon-active" alt="视频作品 Active">
                <span>视频作品</span>
            </a>
            <a href="graphic-portfolio.html">
                <img src="assets/images/icons/graphic.png" class="icon-default" alt="平面设计">
                <img src="assets/images/icons/graphic-active.png" class="icon-active" alt="平面设计 Active">
                <span>平面设计</span>
            </a>
            <a href="contact.html">
                <img src="assets/images/icons/contact.png" class="icon-default" alt="联系方式">
                <img src="assets/images/icons/contact-active.png" class="icon-active" alt="联系方式 Active">
                <span>联系方式</span>
            </a>
        </div>
    </nav>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const workItems = document.querySelectorAll('.work-item');
            const modal = document.getElementById('videoModal');
            const closeBtn = document.querySelector('.close-btn');
            const playerContainer = document.getElementById('videoPlayerContainer');

            // --- 关键新功能：随机视频帧生成封面 ---
            /**
             * 异步函数：加载视频并生成一个随机帧的 Data URL 作为封面。
             * @param {HTMLVideoElement} videoElement - 视频DOM元素。
             * @returns {Promise<string|null>} - 返回 Data URL 字符串或 null。
             */
            function generateRandomPoster(videoElement) {
                return new Promise((resolve) => {
                    const videoSrc = videoElement.querySelector('source').src;
                    const tempVideo = document.createElement('video');
                    tempVideo.src = videoSrc;
                    tempVideo.preload = 'metadata'; // 仅加载元数据
                    tempVideo.muted = true; // 确保加载

                    tempVideo.onloadedmetadata = function() {
                        // 1. 获取视频总时长
                        const duration = tempVideo.duration;
                        
                        // 2. 随机选择一个时间点（避开开头和结尾的 1 秒，以防黑屏）
                        const randomTime = Math.random() * (duration - 2) + 1;
                        tempVideo.currentTime = randomTime;

                        // 3. 监听 seeked 事件（确保视频播放头已到达随机时间点）
                        tempVideo.onseeked = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = tempVideo.videoWidth;
                            canvas.height = tempVideo.videoHeight;
                            const ctx = canvas.getContext('2d');
                            
                            // 绘制当前帧到 Canvas
                            ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                            
                            // 导出为 Data URL
                            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                            resolve(dataURL);
                            
                            // 清理临时元素
                            tempVideo.remove();
                            canvas.remove();
                        };

                        // 处理加载失败或 seek 失败的情况
                        tempVideo.onerror = () => {
                            console.error('视频加载失败或无法 seek:', videoSrc);
                            resolve(null);
                            tempVideo.remove();
                        };
                    };
                    
                    // 如果元数据加载失败，也需要处理
                    tempVideo.onerror = () => resolve(null);
                    
                    // 确保 tempVideo 被加载到 DOM 中才能进行 canvas 操作，但为了性能，我们先尝试不加入
                    // 如果出现 cross-origin 错误，则需要确保视频和页面在同一源。
                });
            }

            // 页面加载时，为每个视频作品生成随机封面
            document.querySelectorAll('.portfolio-grid .work-item').forEach(item => {
                const videoEl = item.querySelector('video');
                
                // 仅当视频元素存在且没有 poster 时执行
                if (videoEl && !videoEl.getAttribute('poster')) {
                    generateRandomPoster(videoEl).then(posterURL => {
                        if (posterURL) {
                            videoEl.setAttribute('poster', posterURL);
                        } else {
                            // 如果生成失败，使用一个默认的占位符（例如：纯色背景）
                            videoEl.setAttribute('poster', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=');
                        }
                    });
                }

                // 鼠标悬停事件（保持不变）
                const container = item.querySelector('.work-media');
                if (container) {
                    container.addEventListener('mouseenter', () => {
                        videoEl.play().catch(error => {
                            console.log('Video auto-play failed:', error);
                        });
                    });

                    container.addEventListener('mouseleave', () => {
                        videoEl.pause();
                        videoEl.currentTime = 0; 
                    });
                }
            });
            // --- 随机封面功能结束 ---

            // 1. 播放器逻辑 (保持不变)
            workItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const videoSrc = this.getAttribute('data-video-src');
                    if (!videoSrc) return;

                    // 创建新的 video 元素
                    const videoElement = document.createElement('video');
                    videoElement.src = videoSrc;
                    videoElement.controls = true; 
                    videoElement.autoplay = true; 
                    videoElement.muted = false; // 弹窗内允许声音
                    videoElement.playsInline = true; 
                    videoElement.classList.add('modal-video-player');

                    playerContainer.innerHTML = '';
                    playerContainer.appendChild(videoElement);

                    // 手机端全屏播放逻辑 
                    if (window.innerWidth <= 1024) { 
                        videoElement.addEventListener('loadedmetadata', function() {
                            if (videoElement.requestFullscreen) {
                                videoElement.requestFullscreen();
                            } else if (videoElement.webkitEnterFullscreen) { 
                                videoElement.webkitEnterFullscreen();
                            }
                        }, { once: true });
                    }

                    // 显示弹窗
                    modal.classList.add('show');
                });
            });

            // 关闭弹窗 (保持不变)
            function closeModal() {
                modal.classList.remove('show');
                playerContainer.innerHTML = ''; 
            }

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    closeModal();
                }
            });


            // 2. 筛选功能 (保持不变)
            document.querySelectorAll('.tags-filter .work-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    document.querySelectorAll('.tags-filter .work-tag').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    const items = document.querySelectorAll('.portfolio-grid .work-item');

                    items.forEach(item => {
                        const tags = item.getAttribute('data-tags');
                        if (filter === 'all' || tags.includes(filter)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>